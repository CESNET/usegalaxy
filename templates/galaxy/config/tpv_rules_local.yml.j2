global:
  default_inherits: default

tools:
  default:
    abstract: true
    cores: 1
    mem: cores * 4
    context:
      scratch: 15
      walltime: 24
    scheduling:
      require:
      - pulsar

  .*testing.*:
    cores: 1
    mem: 1
    context:
      walltime: 1
    rules:
      - id: admin_only_testing_tool
        if: |
          # Only allow the tool to be executed if the user is an admin
          admin_users = app.config.admin_users
          # last line in block must evaluate to a value - which determines whether the TPV if conditional matches or not
          not user or user.email not in admin_users
        fail: Unauthorized. Only admins can execute this tool.

      - id: resource_params_defined
        if: |
          param_dict = job.get_param_values(app)
          param_dict.get('__job_resource', {}).get('__job_resource__select') == 'yes'
        cores: int(job.get_param_values(app)['__job_resource']['cores'])
        context:
           walltime: "{int(job.get_param_values(app)['__job_resource']['time'])}"

#roles:
#  training.*:
#    max_cores: 2
#    max_mem: max_cores * 4  # TODO check multiplier
#    scheduling:
#      require:
#        - pulsar
#        - training

destinations:
  tpv_local:
    runner: local_runner
    max_accepted_cores: 1
    max_accepted_mem: 4
    max_accepted_gpus: 0
    params:
      tmp_dir: true
    scheduling:
      require:
        - local
      reject:
        - pulsar
        - singularity
  tpv_singularity:
    runner: local_runner
    max_accepted_cores: 1
    max_accepted_mem: 4
    max_accepted_gpus: 0
    params:
      singularity_enabled: true
    env:
      # Ensuring a consistent collation environment is good for reproducibility.
      LC_ALL: C
      # The cache directory holds the docker containers that get converted
      SINGULARITY_CACHEDIR: /tmp/singularity
      # Singularity uses a temporary directory to build the squashfs filesystem
      SINGULARITY_TMPDIR: /tmp
    container_resolvers:
    - type: explicit_singularity
    - type: cached_mulled_singularity
      cache_directory: "{{ singularity_local_cache_dir }}/mulled"
    - type: mulled_singularity
    scheduling:
      require:
        - local
      prefer:
        - singularity
      reject:
        - pulsar
  tpv_pulsar:
    runner: pulsar_runner
    max_accepted_cores: 128
    max_accepted_mem: 512
    max_accepted_gpus: 0
    max_cores: 16
    max_mem: 64
    max_gpus: 0
    params:
      default_file_action: remote_transfer
      transport: curl
      dependency_resolution: remote
      jobs_directory: "{{ /opt/pulsar/files/persistent }}"
      persistence_directory: "{{ pulsar_persistence_dir }}"
      remote_metadata: false
      rewrite_parameters: true
      outputs_to_working_directory: false
      #Resource_List: "select=1:ncpus={cores}:mem={mem}gb:scratch_local=50gb,walltime=23:59:59"
      submit_native_specification: "-l select=1:ncpus={cores}:mem={mem}gb:scratch_local={scratch}gb -l walltime={walltime}:00:00 -q galaxyumsa@elixir-pbs.elixir-czech.cz -N pulsar_umsa_j{job.id}__{tool.id if '/' not in tool.id else tool.id.split('/')[-2]+'_v'+tool.id.split('/')[-1]}__{user.username}"
    env:
      LC_ALL: C
      TMPDIR: $SCRATCHDIR
      TMP: $SCRATCHDIR
      TEMP: $SCRATCHDIR 
      GALAXY_SLOTS: "{cores}"
      GALAXY_MEMORY_MB: "{int(mem)*1000}"
    scheduling:
      require:
      - pulsar
      reject:
      - singularity
  tpv_pulsar_singularity:
    inherits: tpv_pulsar
    runner: pulsar_runner
    params:
      singularity_enabled: true
      singularity_volumes: "$job_directory:rw,$tool_directory:ro,$job_directory/outputs:rw,$working_directory:rw,/cvmfs/data.galaxyproject.org:ro,$SCRATCHDIR:rw"
      singularity_default_container_id: "/cvmfs/singularity.galaxyproject.org/all/python:3.8.3"
    env:
      SINGULARITY_CACHEDIR: "/auto/brno11-elixir/home/galaxyumsa/pulsar-umsa/files/singularity_cache"
      SINGULARITY_TMPDIR: "$SCRATCHDIR"
      XDG_CACHE_HOME: "$SCRATCHDIR"
    container_resolvers:  
    - type: explicit_singularity
#      cache_directory: "/auto/brno11-elixir/home/galaxyumsa/pulsar-umsa/singularity"
    - type: cached_mulled_singularity
      cache_directory: "/auto/brno11-elixir/home/galaxyumsa/pulsar-umsa/files/singularity_cache"
    - type: mulled_singularity
#      cache_directory: "/auto/brno11-elixir/home/galaxyumsa/pulsar-umsa/singularity"
    scheduling:
      require:
      - pulsar
      - singularity
      reject:
#  pulsar_gpu:
#    runner: pulsar_gpu_runner
#    max_accepted_cores: 128
#    max_accepted_mem: 512
#    max_accepted_gpus: 2
#    max_cores: 16
#    max_mem: 64
#    max_gpus: 1
#    params:
#      default_file_action: remote_transfer
#      transport: curl
#      dependency_resolution: remote
#      jobs_directory: "/auto/brno11-elixir/home/galaxyumsa/pulsar-umsa/files/staging"
#      persistence_directory: "/opt/pulsar/files/persistent"
#      remote_metadata: false
#      rewrite_parameters: true
#      outputs_to_working_directory: false
#      singularity_enabled: true
#      singularity_run_extra_arguments: '--nv'
#      singularity_volumes: '$job_directory:ro,$tool_directory:ro,$job_directory/outputs:rw,$working_directory:rw,$SCRATCHDIR,$ALPHAFOLD_DB:/data/2.3:ro'
#    env:
#      # The cache directory holds the docker containers that get converted
#      - name: SINGULARITY_CACHEDIR
#        value: "/storage/praha5-elixir/home/galaxyeu/singularity/cache"
#      - name: APPTAINER_CACHEDIR
#        value: "/storage/praha5-elixir/home/galaxyeu/singularity/cache"
#      # Singularity uses a temporary directory to build the squashfs filesystem
#      - name: SINGULARITY_TMPDIR
#        value: "/storage/praha5-elixir/home/galaxyeu/singularity/tmp" 
#      - name: APPTAINER_TMPDIR
#        value: "/storage/praha5-elixir/home/galaxyeu/singularity/tmp"
#      # Alphafold specific variables
#      - name: ALPHAFOLD_DB
#        value: "/storage/brno11-elixir/projects/alphafold/alphafold.db-2.3.1"
#      # Default variables
#      - name: TMPDIR
#        value: "$SCRATCHDIR"
#      - name: TMP
#        value: "$SCRATCHDIR"
#      - name: TEMP
#        value: "$SCRATCHDIR"
#      # Ensuring a consistent collation environment is good for reproducibility.
#      - name: LC_ALL
#        value: C
#    scheduling:
#      require:
#        - pulsar
#        - gpu

#  pulsar-training:
#    inherits: pulsar
#    runner: pulsar_runner
#    max_accepted_cores: 12
#    max_accepted_mem: 120
#    max_cores: 2 # Limit the cores
#    max_mem: 8 # Limit the memory
#    params:
#      native_specification: --nodes=1 --ntasks=1 --mem={round(mem*1024)} --cpus-per-task={cores} --time=00:30:00
#    scheduling:
#      require:
#        - pulsar
#        - training
